開発指示仕様書（ドラフト）
• 案件名: Folder Continuous Video Player (仮)
• 対象OS: Android 14 (API 34) 以上
• 開発言語: Kotlin
• 開発環境: Android Studio
• 最終更新: 2026-02-12
• 目的: 外部ストレージ上の指定フォルダー内にある mp4 動画を、UI最小・オーバーレイ非表示で連続再生できるシンプルなプレーヤーを提供する。

--------------------------------------------------------------------------------
1. スコープ

1.1 対象（やること）
• ユーザーが指定したフォルダー内の mp4 動画ファイルを連続再生する。
• フォルダーは外部ストレージ（共有ストレージ等）に対応。
• 再生中はオーバーレイ（再生バー・ボタン等）を表示しない。
• 再生中の操作はジェスチャーのみで完結し、画面を極力邪魔しない。
• 次の動画を先読みし、連続再生をスムーズにする（ギャップ最小化）。
• フォルダー内のファイル情報を取得し、内部キャッシュに保存して再生時に利用。
• 内部ストレージ使用量は最小限に留める（動画データ等は保存しない）。
• 音声出力: AudioMixerAttributes にて MIXER_BEHAVIOR_BIT_PERFECT を設定し、条件が合う場合はビットパーフェクトで出力を試みる（USBデバイス前提）。

1.2 非対象（やらないこと）
• ストリーミング再生（URL再生）
• プレイリスト編集、検索、タグ、サムネ生成・一覧表示（最低限UIのため）
• 画面上のコントロール類（再生ボタン、シークバー、タイム表示等）
• PiP（ピクチャーインピクチャ）/ バックグラウンド継続再生（通知/MediaSessionの実装を避ける）
• さまざまな動画形式（mp4以外）対応

--------------------------------------------------------------------------------
2. 想定ユーザーフロー

1. 初回起動
    ◦ 「フォルダーを選択」ボタンのみ表示（シンプルな初期画面）。

2. ユーザーがフォルダーを選択（外部ストレージ含む）
    ◦ SAF (Storage Access Framework) のディレクトリ選択を使用。(ACTION_OPEN_DOCUMENT_TREE)
    ◦ 選択後、フォルダー内 mp4 をスキャン -> キャッシュ保存 -> 先頭から再生開始。

3. 2回目以降起動
    ◦ 前回選択フォルダーの権限が有効なら、キャッシュから即時プレイリスト生成して再生開始。
    ◦ 裏で軽量な差分チェックを行い、次回以降のキャッシュ精度を保つ。

--------------------------------------------------------------------------------
3. 画面・UI仕様（最低限）

3.1 画面一覧

A. 初期画面 (FolderSelect)
• 表示要素（最小）
    ◦ ボタン：「フォルダーを選択」
    ◦ テキスト：現在選択中フォルダー名（取得できる場合のみ、無理なら非表示）
    ◦ 進捗：スキャン中のみ「読み込み中...」程度のテキスト

B. 再生画面 (Player / Fullscreen)
• 全画面で動画のみ表示
• アプリ独自のオーバーレイは一切表示しない
    ◦ PlayerViewのコントローラ非表示 (useController=false)
    ◦ バッファリング表示も無効化（可能な範囲で）
• システムバー（ステータス/ナビ）は没入型で非表示
    ◦ WindowInsetsController で隠す

--------------------------------------------------------------------------------
4. 操作仕様（ジェスチャー）

要求: 「再生中は画面の邪魔にならないようにジェスチャーによる操作」「オーバーレイは表示しない」
4.1 ジェスチャーマップ（提案：最低限）
ジェスチャー
動作
備考
シングルタップ
再生/一時停止トグル
  画面表示は出さない（必要ならハプティクのみ）
右スワイプ
  次の動画へ
  即時切替
左スワイプ
  前の動画へ
  先頭なら先頭維持
ダブルタップ（右側）
  +10秒シーク
ダブルタップ（左側）
  -10秒シーク
表示フィードバックなし
端末の戻る
再生終了 -> 初期画面へ
プレイヤー解放、ビットパーフェクト設定解除
• ※音量ジェスチャーは、システムオーバーレイを誘発しやすいため実装しない。

--------------------------------------------------------------------------------
5. ファイル取得仕様（外部ストレージ対応）

5.1 フォルダー指定方式
• SAF (Storage Access Framework) でディレクトリ選択を行う。
• 選択後、永続権限を取得し、次回起動時もアクセス可能にする。
    ◦ contentResolver.takePersistableUriPermission(uri, flags)

5.2 対象ファイル条件
• フォルダー直下のみ（サブフォルダは対象外）。
• 拡張子 .mp4（大文字小文字不問）。
• DocumentのMIMEが取れる場合は video/mp4 を優先。

5.3 ソート順（UI最小のため固定）
• デフォルト：ファイル名昇順。

--------------------------------------------------------------------------------
6. 再生仕様 (Media3/ExoPlayer)

6.1 再生エンジン
• Jetpack Media3 ExoPlayer を採用。
• PlayerView を利用し useController=false （推奨）。

6.2 連続再生の動作
• プレイリスト (MediaItem配列) を作成し、自動で次へ再生。
• 最終ファイル再生終了後は停止（ループなし）。

6.3 エラー時
• 再生不可ファイルはスキップして次の動画へ。
• 権限失効時は初期画面へ戻り「フォルダー再選択」を誘導。

--------------------------------------------------------------------------------
7. 先読み（プリロード）仕様
• 目的：切替時のブラックアウトや待ち時間を最小化。
• 実装方針：Media3 の PreloadConfiguration を使用。
• 例：次のメディアの先頭5秒相当をプリロード。

--------------------------------------------------------------------------------
8. 内部キャッシュ仕様（最小限）

8.1 目的
• スキャン結果を内部ストレージに保存し、再生開始までを高速化。

8.2 保存場所
• context.filesDir 内の1ファイル。

8.3 保存データ (JSON/Proto)
• cacheVersion, treeUri, generatedAt, items (uri, displayName, size, lastModified, duration, sortKey)。
• 禁止: サムネ・動画データなどの巨大なデータの保存。

8.4 更新条件
• フォルダー変更時は作り直し。
• 同じフォルダーでも、ファイル数や更新日時に差分があればバックグラウンドで再スキャン。

--------------------------------------------------------------------------------
9. 音声出力仕様（ビットパーフェクト）
要求: AudioMixerAttributes に MIXER_BEHAVIOR_BIT_PERFECT を設定。

9.1 前提と制約
• USB出力前提。HALへデータをそのまま送る挙動。
• MODIFY_AUDIO_SETTINGS 権限が必要。

9.2 実装要件
1. USB出力デバイスを検出。
2. MIXER_BEHAVIOR_BIT_PERFECT かつフォーマットが一致する属性を選択。
3. setPreferredMixerAttributes を呼び出し、停止時に解除。

9.3 フォーマット一致戦略
• A案（簡易・推奨）: 再生予定ファイルの音声情報（サンプルレート等）を MediaExtractor で読み取り、一致する候補を選ぶ。

--------------------------------------------------------------------------------
10. 権限・マニフェスト要件
• minSdk=34, targetSdk=34以上
• 権限: android.permission.MODIFY_AUDIO_SETTINGS
• SAF使用のため従来のストレージ権限は原則不要。

--------------------------------------------------------------------------------
11. 実装構成（推奨）

11.1 主要クラス案
• MainActivity, FolderPicker, VideoRepository, VideoCacheStore, PlayerController

11.2 依存ライブラリ
• Jetpack Media3 ExoPlayer (必須)
• media3-ui, DocumentFile

--------------------------------------------------------------------------------
12. 受け入れ条件 (Acceptance Criteria)
1. フォルダー内の .mp4 がファイル名昇順で連続再生される。
2. 再生中にアプリ独自のオーバーレイが出ない。
3. ジェスチャーで「再生/一時停止」「次/前」「±10秒シーク」が可能。
4. 先読みにより切替がスムーズ。
5. キャッシュにより次回起動時に即時再生開始。
6. 内部ストレージ消費が最小限。
7. Android 14+ でUSBオーディオ接続時、ビットパーフェクト設定が機能する。

claude --resume 7f1adcb0-65ac-44dc-b4d6-a1d8178d2cd6
